# Copilot Instructions for @harperfast/oauth

## Repository Overview

**@harperfast/oauth** is an OAuth 2.0 and OpenID Connect authentication plugin for Harper (HarperDB) applications. This is a TypeScript library that compiles to JavaScript and is published to npm.

- **Language**: TypeScript (targeting ES2022, NodeNext modules)
- **Runtime**: Node.js >= 20, Bun >= 1.0
- **Package Manager**: npm (do NOT use yarn or pnpm)
- **Size**: Small library (~20 source files, ~20 test files)
- **Purpose**: Provides multi-provider OAuth authentication (GitHub, Google, Azure AD, Auth0, Okta, custom OIDC)

## Build & Validation Workflow

### Essential Commands (In Order)

**ALWAYS run commands in this exact order:**

1. **Install dependencies**: `npm ci` (takes ~20-30 seconds)
   - Use `npm ci` for clean, reproducible installs (NOT `npm install`)
   - This reads package-lock.json for deterministic installs
   - npm will show 28 vulnerabilities (3 low, 2 moderate, 23 high) from harperdb dependency - this is expected and can be ignored

2. **Build the project**: `npm run build` (takes ~3-5 seconds)
   - Runs `tsc || true` - TypeScript compiler with failure tolerance
   - Outputs to `dist/` directory
   - Note: The `|| true` allows the build to succeed even with TypeScript errors
   - ALWAYS check TypeScript output for actual errors despite exit code 0

3. **Lint code**: `npm run lint` (takes ~3-5 seconds)
   - Runs ESLint on all files except dist/
   - Uses @harperdb/code-guidelines
   - Must pass with no errors before committing

4. **Check formatting**: `npm run format:check` (takes ~3-5 seconds)
   - Runs Prettier to check code formatting
   - Uses @harperdb/code-guidelines prettier config
   - Must pass before committing

5. **Run tests**: `npm test` (takes ~60-90 seconds)
   - Rebuilds project, then runs Node.js native test runner
   - Runs all test/\*_/_.test.js files
   - 307 tests should pass, 2 skipped (expected)
   - You will see several "uncaughtException" errors in output - these are EXPECTED and do NOT indicate test failures
   - Tests use HarperDB mocking which causes harmless path errors in test output
   - Look for final summary: `ℹ pass 307` and `ℹ fail 0` to verify success

### Other Available Commands

- `npm run format:write` - Auto-fix formatting issues
- `npm run test:coverage` - Run tests with coverage (Node 22+ only, takes ~60-90 seconds)
- `npm run test:watch` - Watch mode for tests during development
- `npm run dev` - TypeScript watch mode for development

### After Making Code Changes

**ALWAYS run in this order:**

1. `npm run build` - Verify TypeScript compiles
2. `npm run lint` - Check linting
3. `npm run format:check` - Check formatting (or run `npm run format:write` to auto-fix)
4. `npm test` - Verify all tests pass

### CI/CD Pipeline

The repository has GitHub Actions workflows in `.github/workflows/`:

**pr-checks.yml** - Runs on all PRs and pushes to main:

- Tests on Node.js versions: 20, 22, 24 (matrix)
- Tests with Bun runtime (latest)
- Steps: checkout → install → lint → format:check → test
- Node 20 uses `npm run test:node-twenty` (without coverage)
- Node 22+ uses `npm run test:coverage`
- Bun uses `bun test` command

**release.yml** - Runs on release publish:

- Uses Node.js 22
- Steps: checkout → install → lint → format:check → test → publish to npm

**To pass CI, your changes MUST:**

- Pass `npm run lint` with no errors
- Pass `npm run format:check` with no errors
- Pass `npm test` with all tests passing
- Work on Node.js 20, 22, and 24

## Project Structure

### Root Directory Files

```
/home/runner/work/oauth/oauth/
├── .github/          # GitHub workflows and CODEOWNERS
│   └── workflows/    # CI/CD pipelines (pr-checks.yml, release.yml)
├── src/              # TypeScript source code
│   ├── index.ts      # Main plugin entry point
│   ├── types.ts      # TypeScript type definitions
│   └── lib/          # Core library code
├── dist/             # Compiled JavaScript (gitignored, generated by tsc)
├── test/             # Test files (JavaScript, using Node.js test runner)
├── docs/             # Documentation (markdown files)
├── schema/           # GraphQL schema for OAuth tables
├── examples/         # Example usage files
├── assets/           # Static assets
├── package.json      # npm package configuration
├── tsconfig.json     # TypeScript compiler configuration
├── eslint.config.js  # ESLint configuration (uses @harperdb/code-guidelines)
├── prettier.config.js # Prettier configuration (uses @harperdb/code-guidelines)
├── config.yaml       # Plugin configuration for Harper
└── bunfig.toml       # Bun test configuration
```

### Source Code Organization

**src/index.ts** - Main entry point, exports public API and plugin initialization
**src/types.ts** - All TypeScript interfaces and types
**src/lib/** - Core implementation:

- `resource.ts` - OAuthResource class (main HTTP handler)
- `OAuthProvider.ts` - OAuth provider implementation
- `handlers.ts` - HTTP route handlers (login, callback, logout, user info)
- `sessionValidator.ts` - Session validation and token refresh logic
- `hookManager.ts` - Lifecycle hooks (onLogin, onLogout, onTokenRefresh)
- `config.ts` - Configuration parsing and provider initialization
- `CSRFTokenManager.ts` - CSRF token storage and validation
- `tenantManager.ts` - Multi-tenant SSO support
- `withOAuthValidation.ts` - Middleware wrapper
- `providers/` - Provider presets (github.ts, google.ts, azure.ts, auth0.ts, okta.ts, generic.ts, validation.ts, index.ts)

### Test Organization

Tests are in `test/` directory:

- `test/lib/` - Unit tests for library modules (match src/lib/ structure)
- `test/helpers/` - Test utilities (mockFn.js)
- Root test files - Integration tests
- All test files use `.test.js` extension
- Tests use Node.js native test runner (`node --test`)
- Mocking is done with custom helpers, not external libraries

### Configuration Files

- **tsconfig.json** - Target: ES2022, Module: NodeNext, outputs to dist/
- **eslint.config.js** - Extends @harperdb/code-guidelines
- **prettier.config.js** - Uses @harperdb/code-guidelines
- **config.yaml** - Harper plugin configuration (defines pluginModule, schema, defaults)
- **bunfig.toml** - Bun test preload configuration
- **.gitignore** - Excludes: dist/, node_modules/, coverage, .env files

## Important Implementation Details

### Security Practices

This codebase has strong security practices that MUST be maintained:

1. **Redirect URL Sanitization**: Use `sanitizeRedirect()` function from `lib/handlers.ts` to sanitize all redirect URLs (strips protocols, keeps only pathname/search/hash). This prevents open redirect vulnerabilities.

2. **SSRF Protection**: Use `validateDomainSafety()` from `lib/providers/validation.ts` for any user-provided domains (Okta, Auth0, Azure). This blocks private IPs, localhost, AWS metadata endpoints, and dangerous protocols.

3. **Input Validation**: Use validation functions from `lib/providers/validation.ts`:
   - `validateEmailDomain()` - Validates email domains (blocks CRLF injection)
   - `validateTenantId()` - Validates tenant IDs (alphanumeric + hyphens/underscores, 3-64 chars)
   - `sanitizeTenantName()` - HTML escapes tenant names (XSS protection)
   - `validateAzureTenantId()` - Validates Azure tenant IDs (GUID or special values)

4. **Token Security**: Tokens are stored in sessions, CSRF tokens expire after 10 minutes

### Code Style & Conventions

- **No comments** unless explaining complex logic (existing code has minimal comments)
- **Use async/await** for asynchronous operations
- **Strict TypeScript** - all options enabled (strict, noUnusedLocals, noUnusedParameters)
- **ES Modules** - use import/export (type: "module" in package.json)
- **Logging** - Use logger?.debug?.(), logger?.info?.(), logger?.warn?.(), logger?.error?.()
- **Error handling** - Throw descriptive errors, catch and log appropriately

### Testing Conventions

- Use Node.js native test runner (describe, it, beforeEach, afterEach)
- Mock external dependencies with custom mockFn helper from test/helpers/mockFn.js
- Test file naming: `{module-name}.test.js`
- Group tests with describe blocks
- Keep tests focused and isolated
- Mock HarperDB table operations in tests

### Common Gotchas & Pitfalls

1. **Build script uses `|| true`**: The TypeScript compiler may show errors but the build script always exits 0. ALWAYS check the actual tsc output for errors.

2. **Test output shows "uncaughtException" errors**: These are EXPECTED from HarperDB mocking internals. Only check final test summary for actual failures.

3. **Dependencies have vulnerabilities**: npm will report 28 vulnerabilities from harperdb peer dependency. This is expected and not your responsibility to fix.

4. **Node 20 vs 22+**: Test coverage only works on Node 22+. Node 20 uses a different test command (`test:node-twenty`) without coverage.

5. **Don't use npm install**: Always use `npm ci` for reproducible installs based on package-lock.json.

6. **dist/ directory**: This is generated by TypeScript compiler and should never be edited directly. It's gitignored.

7. **Package.json "files" field**: Only dist/, assets/, schema/, and specific files are published to npm.

## Dependencies & Peer Dependencies

**Runtime Dependencies:**

- `jsonwebtoken` ^9.0.2 - JWT token handling
- `jwks-rsa` ^3.1.0 - JWKS key fetching for ID token verification

**Peer Dependencies:**

- `harperdb` >=4.6.0 - Required runtime environment (not installed in dev)

**Dev Dependencies:**

- TypeScript, ESLint, Prettier
- @harperdb/code-guidelines - Code style configuration
- harperdb ^4.7.14 - For testing (mocked)

## Documentation Files

The `docs/` directory contains:

- `getting-started.md` - Installation and quickstart
- `configuration.md` - Configuration reference
- `providers.md` - Provider setup guides
- `lifecycle-hooks.md` - Hook system documentation
- `api-reference.md` - API endpoints
- `token-refresh-and-sessions.md` - Token lifecycle
- `multi-tenant-sso.md` - Multi-tenant configuration

## Making Changes

When implementing features or fixes:

1. **Understand the OAuth flow**: Review src/lib/handlers.ts for the complete OAuth flow
2. **Use existing patterns**: Look at similar providers in src/lib/providers/ for examples
3. **Maintain security**: Use validation functions, sanitize inputs, follow existing patterns
4. **Update types**: Add/update TypeScript types in src/types.ts as needed
5. **Add tests**: Follow existing test patterns in test/lib/
6. **Build incrementally**: Build → Lint → Format → Test after each change
7. **Don't break existing tests**: All 307 tests must continue passing

## Trust These Instructions

These instructions have been validated by:

- Running clean install and build from scratch
- Executing all commands in sequence
- Running complete test suite
- Reviewing all documentation
- Examining CI/CD pipeline configuration
- Testing the workflow with multiple Node.js versions

**Only search for additional information if:**

- These instructions are incomplete for your specific task
- You find an error or inconsistency in these instructions
- You need to understand implementation details not covered here

Otherwise, trust and follow these instructions to work efficiently.
